<!DOCTYPE html>
<meta charset="UTF-8" />
<html lang="en">
    <head>
        <title>capsid</title>
        <link rel="stylesheet" href="css/index.css" />
        <script type="text/javascript" src="js/lib/paper-js/paper-core.min.js"></script>
        <script type="text/javascript" src="js/linalg.js"></script>
        <script type="text/javascript" src="js/index.js"></script>
        <script type="text/javascript">
            const PARSERS = {
                color: (e) => e.value,
                alpha: (e) => Number(e.value).toString(16).padStart(2, "0"),
                toggle: (e) => e.checked,
                size: (e) => parseFloat(e.value),
                length: (e) => parseFloat(e.value),
            };

            const DEFAULTS = Object.assign(
                {},
                {
                    h: (e) => parseInt(e.value),
                    k: (e) => parseInt(e.value),
                    H: (e) => parseInt(e.value),
                    K: (e) => parseInt(e.value),
                    s: (e) => parseInt(e.value),
                    t: (e) => e.value,
                    R: (e) => parseFloat(e.value),
                    θ: (e) => parseFloat(e.value),
                    ψ: (e) => parseFloat(e.value),
                    φ: (e) => parseFloat(e.value),
                },
                Object.fromEntries([
                    ...["net", "capsid"].map((e) => ["mode_" + e, PARSERS.toggle]),
                    ...["penton_fiber", "knob"].map((e) => [e + "_toggle", PARSERS.toggle]),
                    ...["line", "fiber", "knob"].flatMap((e) => ["color", "alpha", "size"].map((f) => [e + "_" + f, PARSERS[f]])),
                    ...["color", "alpha", "size", "length"].map((e) => ["fiber_" + e, PARSERS[e]]),
                    ...["color", "alpha", "toggle"].flatMap((e) => Array.from({ length: 6 }, (_, i) => ["mer_" + e + "_" + (i + 1), PARSERS[e]])),
                ])
            );

            function params() {
                return Object.fromEntries(Object.keys(DEFAULTS).map((k) => [k, DEFAULTS[k](document.getElementById(k))]));
            }

            function download_svg() {
                // https://www.mikechambers.com/blog/post/2014-07-01-saving-svg-content-from-paper.js/
                const PARAMS = params();
                const name = ["t", "h", "k", "H", "K", "s", "R"].map((k) => PARAMS[k]).join("_");
                var link = document.createElement("a");
                link.download = name + ".svg";
                link.href =
                    "data:image/svg+xml;utf8," +
                    encodeURIComponent(
                        project.exportSVG({
                            "options.bounds": "content",
                            asString: true,
                            "options.matchShapes": true,
                        })
                    );
                link.click();
            }

            function update(e) {
                paper.clear();
                paper.setup("model");
                const PARAMS = params();
                const draw = PARAMS.mode_capsid ? draw_capsid : draw_net;
                msg.style.display = "none";
                try {
                    draw(PARAMS);
                } catch (e) {
                    paper.clear();
                    const canvas = document.getElementById("model");
                    canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
                    const msg = document.getElementById("msg");
                    msg.style.display = "block";
                    msg.children[1].innerText = e;
                }
            }

            paper.install(window);

            window.onload = function (opt) {
                Object.keys(DEFAULTS).forEach((e) => document.getElementById(e).addEventListener("change", update));
                document.getElementById("msg").style.display = "none";
                document.getElementById("download_svg").addEventListener("click", download_svg);
                document.getElementById("show_citation").addEventListener("click", () => document.getElementById("citation").showModal());
                document.getElementById("close_citation").addEventListener("click", () => document.getElementById("citation").close());
                document.getElementById("penton_fiber_toggle").addEventListener("change", (e) => (document.getElementById("knob_toggle").disabled = !e.target.checked));
                update();
            };
        </script>
    </head>
    <body>
        <fieldset>
            <legend>democapsid</legend>
            <canvas id="model" resize> Your browser does not support the HTML canvas tag. </canvas>
        </fieldset>
        <fieldset id="msg">
            <legend>message</legend>
            <div></div>
        </fieldset>
        <fieldset>
            <legend>mode</legend>
            <label for="mode_net">net</label>
            <input type="radio" id="mode_net" name="mode" value="net" />
            <label for="mode_capsid">capsid</label>
            <input type="radio" id="mode_capsid" name="mode" value="capsid" checked />
            <button id="download_svg">Download SVG</button>
            <button id="show_citation">Cite!</button>
        </fieldset>
        <fieldset>
            <legend>model</legend>
            <div>
                <label for="h">h&nbsp;=&nbsp;</label>
                <input type="number" id="h" step="1" value="3" min="0" />
                <label for="k">k&nbsp;=&nbsp;</label>
                <input type="number" id="k" step="1" value="1" min="0" />
                <label for="H">H&nbsp;=&nbsp;</label>
                <input type="number" id="H" step="1" value="4" min="0" />
                <label for="K">K&nbsp;=&nbsp;</label>
                <input type="number" id="K" step="1" value="2" min="0" />
            </div>
            <div>
                <label for="s">S&nbsp;=&nbsp;</label>
                <select id="s">
                    <option value="5">5</option>
                    <option value="3">3</option>
                    <option value="2">2</option>
                </select>
                <label for="R">R&nbsp;=&nbsp;</label>
                <input type="number" id="R" step="1" value="25" min="1" />
                <label for="t">t&nbsp;=&nbsp;</label>
                <select id="t">
                    <option value="hex">hex</option>
                    <option value="trihex">trihex</option>
                    <option value="snubhex">snubhex</option>
                    <option value="rhombitrihex">rhombitrihex</option>
                    <option value="dualhex">dualhex</option>
                    <option value="dualtrihex">dualtrihex</option>
                    <option value="dualsnubhex">dualsnubhex</option>
                    <option value="dualrhombitrihex">dualrhombitrihex</option>
                </select>
            </div>
        </fieldset>
        <fieldset>
            <legend>rotation</legend>
            <label for="θ">θ&nbsp;=&nbsp;</label>
            <input type="number" id="θ" step="10" value="0" />
            <label for="ψ">ψ&nbsp;=&nbsp;</label>
            <input type="number" id="ψ" step="10" value="0" />
            <label for="φ">φ&nbsp;=&nbsp;</label>
            <input type="number" id="φ" step="10" value="90" />
        </fieldset>
        <fieldset>
            <legend>fiber</legend>
            <label for="penton_fiber_toggle">penton</label>
            <input type="checkbox" id="penton_fiber_toggle" checked />
            <label for="knob_toggle">knob</label>
            <input type="checkbox" id="knob_toggle" checked />
        </fieldset>
        <fieldset>
            <legend>aesthetics</legend>
            <table>
                <tbody>
                    <tr>
                        <th>key</th>
                        <th>line</th>
                        <th>fiber</th>
                        <th>knob</th>
                    </tr>
                    <tr>
                        <td>color</td>
                        <td><input type="color" id="line_color" , value="#000000" /></td>
                        <td><input type="color" id="fiber_color" value="#eded61" /></td>
                        <td><input type="color" id="knob_color" value="#ffa500" /></td>
                    </tr>
                    <tr>
                        <td>alpha</td>
                        <td><input type="number" id="line_alpha" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="fiber_alpha" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="knob_alpha" step="1" value="127" min="0" max="255" /></td>
                    </tr>
                    <tr>
                        <td>size</td>
                        <td><input type="number" id="line_size" step="0.5" value="3" min="0" /></td>
                        <td><input type="number" id="fiber_size" step="0.5" value="6" min="0" /></td>
                        <td><input type="number" id="knob_size" step="0.5" value="9" min="0" /></td>
                    </tr>
                    <tr>
                        <td>length</td>
                        <td>n/a</td>
                        <td><input type="number" id="fiber_length" step="1" value="40" min="0" /></td>
                        <td>n/a</td>
                    </tr>
                </tbody>
            </table>
            <br />
            <table>
                <tbody>
                    <tr>
                        <th>key</th>
                        <th>pentamer-1</th>
                        <th>pentamer-2</th>
                        <th>pentamer-3</th>
                        <th>hexamer-1</th>
                        <th>hexamer-2</th>
                        <th>hexamer-3</th>
                    </tr>
                    <tr>
                        <td>color</td>
                        <td><input type="color" id="mer_color_1" value="#6da59b" /></td>
                        <td><input type="color" id="mer_color_2" value="#aed6d4" /></td>
                        <td><input type="color" id="mer_color_3" value="#8291c2" /></td>
                        <td><input type="color" id="mer_color_4" value="#92be5f" /></td>
                        <td><input type="color" id="mer_color_5" value="#44782c" /></td>
                        <td><input type="color" id="mer_color_6" value="#3278ad" /></td>
                    </tr>
                    <tr>
                        <td>alpha</td>
                        <td><input type="number" id="mer_alpha_1" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="mer_alpha_2" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="mer_alpha_3" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="mer_alpha_4" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="mer_alpha_5" step="1" value="255" min="0" max="255" /></td>
                        <td><input type="number" id="mer_alpha_6" step="1" value="255" min="0" max="255" /></td>
                    </tr>
                    <tr>
                        <td>fiber</td>
                        <td><input type="checkbox" id="mer_toggle_1" /></td>
                        <td><input type="checkbox" id="mer_toggle_2" /></td>
                        <td><input type="checkbox" id="mer_toggle_3" /></td>
                        <td><input type="checkbox" id="mer_toggle_4" /></td>
                        <td><input type="checkbox" id="mer_toggle_5" /></td>
                        <td><input type="checkbox" id="mer_toggle_6" /></td>
                    </tr>
                </tbody>
            </table>
        </fieldset>
        <dialog id="citation">
            <div>
                Please comment on or cite the preprint at <a href="https://www.biorxiv.org/content/10.1101/2020.12.02.408252v1">bioRxiv</a> or Chapter 2 of the
                <a href="http://www.proquest.com/docview/2572612100/abstract/9972F7D348C34013PQ/1">dissertation</a>.
            </div>
            <div>This work previously went by the name "capsid.js" and is now "democapsid".</div>
            <button id="close_citation">close</button>
        </dialog>
    </body>
</html>
